<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Unsere Einkaufsliste</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #2E7D32; 
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #222;
            --border-color: #ddd;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: sans-serif;
            margin: 0; background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 100px;
        }

        header {
            background-color: var(--primary-color);
            color: white; padding: 15px; text-align: center;
            position: sticky; top: 0; z-index: 1000;
        }

        .tabs {
            display: flex; background: white;
            position: sticky; top: 54px; z-index: 900;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1; padding: 15px; border: none; background: none;
            font-weight: bold; color: #666; cursor: pointer;
        }

        .tab-btn.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }

        .search-container { padding: 10px; background: white; }
        #search-input {
            width: 100%; padding: 12px; border: 1px solid #ccc;
            border-radius: 25px; font-size: 1rem;
        }

        .view-section { display: none; padding: 12px; }
        .view-section.active { display: block; }

        .cat-title { font-weight: bold; margin: 20px 0 10px; color: var(--primary-color); border-bottom: 1px solid #ddd; }

        .product-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;
        }

        .product-card {
            background: white; padding: 10px; border-radius: 12px; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;
        }
        .product-card.in-cart { border: 2px solid var(--primary-color); background: #f1f8e9; }

        .prod-icon { font-size: 2rem; display: block; }
        .prod-name { font-size: 0.8rem; font-weight: bold; display: block; margin: 5px 0; }

        .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .btn-ctrl { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ccc; background: white; font-weight: bold; }
        .btn-plus { background: var(--primary-color); color: white; border: none; }

        .shopping-list-item {
            background: white; margin-bottom: 8px; padding: 12px; border-radius: 10px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .shopping-list-item.checked { opacity: 0.5; text-decoration: line-through; }

        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; padding: 15px; background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none;
        }
        .bottom-bar.visible { display: block; }
        .btn-pdf { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <header><h1>ðŸ›’ Unsere Cloud-Liste</h1></header>

    <nav class="tabs">
        <button class="tab-btn active" onclick="app.switchTab('all')">Produkte</button>
        <button class="tab-btn" onclick="app.switchTab('cats')">Kategorien</button>
        <button class="tab-btn" onclick="app.switchTab('shop')">Einkaufen</button>
    </nav>

    <div id="search-wrapper" class="search-container">
        <input type="text" id="search-input" placeholder="Suchen..." oninput="app.handleSearch()">
    </div>

    <section id="view-all" class="view-section active"><div id="grid-container" class="product-grid"></div></section>
    <section id="view-cats" class="view-section"><div id="cat-list-container"></div></section>
    <section id="view-shop" class="view-section"><div id="shopping-list-container"></div></section>

    <div id="shop-footer" class="bottom-bar">
        <button class="btn-pdf" onclick="app.exportPDF()">ðŸ“„ PDF exportieren</button>
    </div>

    <script type="module">
        // Firebase Setup
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDchXMOrJO3Qy9yQISP87vOeE7vZU5yD4",
            authDomain: "einkaufsliste-746a1.firebaseapp.com",
            databaseURL: "https://einkaufsliste-746a1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "einkaufsliste-746a1",
            storageBucket: "einkaufsliste-746a1.firebasestorage.app",
            messagingSenderId: "152718589857",
            appId: "1:152718589857:web:896512392d7ae7c3e995e0"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        const dbRef = ref(db, 'shared-shopping-list');

        const CATALOG = [
            { name: "Erdbeeren", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ“" },
            { name: "Heidelbeeren", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ«" },
            { name: "Himbeeren", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ’" },
            { name: "Brokkoli", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥¦" },
            { name: "Champignons", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ„" },
            { name: "Karfiol", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥¦" },
            { name: "Lauch", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥¬" },
            { name: "Blattsalat", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥¬" },
            { name: "Eisbergsalat", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥¬" },
            { name: "Vogerlsalat", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥—" },
            { name: "Babyblattspinat", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸƒ" },
            { name: "Orangen", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸŠ" },
            { name: "Mandarinen", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸŠ" },
            { name: "Zitronen", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ‹" },
            { name: "Trauben", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ‡" },
            { name: "Avokado", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥‘" },
            { name: "Kiwi", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥" },
            { name: "Mango", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥­" },
            { name: "Birnen", category: "Obst & GemÃ¼se", side: "O", icon: "ðŸ" },
            { name: "Ã„pfel", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸŽ" },
            { name: "Bananen", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸŒ" },
            { name: "Zwiebeln", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ§…" },
            { name: "Kartoffeln", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥”" },
            { name: "SÃ¼ÃŸkartoffel", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ " },
            { name: "Ingwer", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ«š" },
            { name: "Knoblauch", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ§„" },
            { name: "Rote RÃ¼ben Frisch", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥”" },
            { name: "Rote RÃ¼ben Vorgekocht", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥”" },
            { name: "Karotten", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥•" },
            { name: "Gurken", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥’" },
            { name: "Paprika", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ«‘" },
            { name: "Melanzani", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ†" },
            { name: "Zucchini", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ¥’" },
            { name: "Kokosmilch", category: "Vorratsschrank", side: "O", icon: "ðŸ¥¥" },
            { name: "Tomaten", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ…" },
            { name: "Cocktailtomaten", category: "Obst & GemÃ¼se", side: "W", icon: "ðŸ…" },
            { name: "Walnusskerne", category: "Vorratsschrank", side: "O", icon: "ðŸ¥œ" },
            { name: "Cashewkerne", category: "Vorratsschrank", side: "O", icon: "ðŸ¥œ" },
            { name: "Brot", category: "Backwaren", side: "W", icon: "ðŸž" },
            { name: "Semmeln", category: "Backwaren", side: "W", icon: "ðŸ¥¯" },
            { name: "Zopf", category: "Backwaren", side: "W", icon: "ðŸž" },
            { name: "Wraps", category: "Backwaren", side: "W", icon: "ðŸŒ¯" },
            { name: "Haferflocken grob", category: "Vorratsschrank", side: "O", icon: "ðŸ¥£" },
            { name: "Haferflocken fein", category: "Vorratsschrank", side: "O", icon: "ðŸ¥£" },
            { name: "MÃ¼sli", category: "Vorratsschrank", side: "O", icon: "ðŸ¥£" },
            { name: "MÃ¼sliriegel", category: "SÃ¼ÃŸigkeiten", side: "W", icon: "ðŸ«" },
            { name: "Toastbrot", category: "Vorratsschrank", side: "O", icon: "ðŸž" },
            { name: "Honig", category: "Vorratsschrank", side: "O", icon: "ðŸ¯" },
            { name: "Kaffee", category: "Vorratsschrank", side: "O", icon: "â˜•" },
            { name: "Vollmilchschokolade", category: "SÃ¼ÃŸigkeiten", side: "W", icon: "ðŸ«" },
            { name: "Zartbitterschokolade", category: "SÃ¼ÃŸigkeiten", side: "W", icon: "ðŸ«" },
            { name: "Chips", category: "SÃ¼ÃŸigkeiten", side: "W", icon: "ðŸ¥¨" },
            { name: "Kekse", category: "SÃ¼ÃŸigkeiten", side: "W", icon: "ðŸª" },
            { name: "GummibÃ¤rchen", category: "SÃ¼ÃŸigkeiten", side: "W", icon: "ðŸ»" },
            { name: "Wein", category: "GetrÃ¤nke", side: "O", icon: "ðŸ·" },
            { name: "Bier", category: "GetrÃ¤nke", side: "O", icon: "ðŸº" },
            { name: "Shampoo", category: "Haushalt", side: "O", icon: "ðŸ§´" },
            { name: "Zahnpasta", category: "Haushalt", side: "O", icon: "ðŸª¥" },
            { name: "GeschirrspÃ¼lertabs", category: "Haushalt", side: "O", icon: "ðŸ§¼" },
            { name: "Klopapier", category: "Haushalt", side: "O", icon: "ðŸ§»" },
            { name: "KÃ¼chenrolle", category: "Haushalt", side: "O", icon: "ðŸ§»" },
            { name: "MÃ¼llbeutel", category: "Haushalt", side: "O", icon: "ðŸ—‘ï¸" },
            { name: "Vanilleeis", category: "TiefkÃ¼hl", side: "O", icon: "ðŸ¦" },
            { name: "Mehl", category: "Vorratsschrank", side: "O", icon: "ðŸŒ¾" },
            { name: "Zucker", category: "Vorratsschrank", side: "O", icon: "ðŸš" },
            { name: "Ã–l", category: "Vorratsschrank", side: "O", icon: "ðŸ§´" },
            { name: "Eier", category: "Vorratsschrank", side: "O", icon: "ðŸ¥š" },
            { name: "Salz", category: "Vorratsschrank", side: "O", icon: "ðŸ§‚" },
            { name: "Faschiertes", category: "KÃ¼hlung", side: "O", icon: "ðŸ¥©" },
            { name: "HÃ¼hnerfleisch", category: "KÃ¼hlung", side: "O", icon: "ðŸ—" },
            { name: "KÃ¤se", category: "KÃ¼hlung", side: "O", icon: "ðŸ§€" },
            { name: "Topfen", category: "KÃ¼hlung", side: "O", icon: "ðŸ¥›" },
            { name: "Spaghetti", category: "Vorratsschrank", side: "O", icon: "ðŸ" },
            { name: "Reis", category: "Vorratsschrank", side: "O", icon: "ðŸš" },
            { name: "TiefkÃ¼hlgemÃ¼se", category: "TiefkÃ¼hl", side: "O", icon: "â„ï¸" },
            { name: "Joghurt", category: "KÃ¼hlung", side: "O", icon: "ðŸ¥›" },
            { name: "Milch", category: "KÃ¼hlung", side: "O", icon: "ðŸ¥›" },
            { name: "Butter", category: "KÃ¼hlung", side: "O", icon: "ðŸ§ˆ" },
            { name: "Mineralwasser", category: "GetrÃ¤nke", side: "O", icon: "ðŸ’§" },
            { name: "Apfelsaft", category: "GetrÃ¤nke", side: "O", icon: "ðŸ§ƒ" },
            { name: "Batterien", category: "Kassa", side: "O", icon: "ðŸ”‹" }
        ];

        window.app = {
            cart: {}, searchTerm: '', activeTab: 'all',

            init: function() {
                // Echtzeit-Ãœberwachung der Cloud-Daten
                onValue(dbRef, (snapshot) => {
                    this.cart = snapshot.val() || {};
                    this.refreshCurrentView();
                });
            },

            saveToCloud: function() {
                set(dbRef, this.cart);
            },

            updateQty: function(name, delta) {
                if (!this.cart[name]) this.cart[name] = { qty: 0, checked: false };
                this.cart[name].qty += delta;
                if (this.cart[name].qty <= 0) delete this.cart[name];
                this.saveToCloud();
            },

            toggleCheck: function(name) {
                if (this.cart[name]) {
                    this.cart[name].checked = !this.cart[name].checked;
                    this.saveToCloud();
                }
            },

            switchTab: function(tab) {
                this.activeTab = tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.onclick.toString().includes(tab)));
                document.querySelectorAll('.view-section').forEach(s => s.classList.toggle('active', s.id === 'view-' + tab));
                document.getElementById('shop-footer').classList.toggle('visible', tab === 'shop');
                this.refreshCurrentView();
            },

            handleSearch: function() {
                this.searchTerm = document.getElementById('search-input').value.toLowerCase();
                this.refreshCurrentView();
            },

            refreshCurrentView: function() {
                if (this.activeTab === 'all') this.renderGrid();
                if (this.activeTab === 'cats') this.renderCats();
                if (this.activeTab === 'shop') this.renderShop();
            },

            renderGrid: function() {
                const filtered = CATALOG.filter(p => p.name.toLowerCase().includes(this.searchTerm));
                document.getElementById('grid-container').innerHTML = filtered.map(p => this.createCard(p)).join('');
            },

            renderCats: function() {
                const container = document.getElementById('cat-list-container');
                container.innerHTML = '';
                const cats = [...new Set(CATALOG.map(p => p.category))];
                cats.forEach(cat => {
                    const items = CATALOG.filter(p => p.category === cat && p.name.toLowerCase().includes(this.searchTerm));
                    if (items.length > 0) {
                        container.innerHTML += `<div class="cat-title">${cat}</div><div class="product-grid">${items.map(p => this.createCard(p)).join('')}</div>`;
                    }
                });
            },

            createCard: function(p) {
                const qty = this.cart[p.name]?.qty || 0;
                return `
                <div class="product-card ${qty > 0 ? 'in-cart' : ''}">
                    <div onclick="app.updateQty('${p.name}', 1)">
                        <span class="prod-icon">${p.icon}</span>
                        <span class="prod-name">${p.name}</span>
                    </div>
                    <div class="controls">
                        <button class="btn-ctrl" onclick="app.updateQty('${p.name}', -1)">-</button>
                        <span>${qty || ''}</span>
                        <button class="btn-ctrl btn-plus" onclick="app.updateQty('${p.name}', 1)">+</button>
                    </div>
                </div>`;
            },

            renderShop: function() {
                const container = document.getElementById('shopping-list-container');
                const items = CATALOG.filter(p => this.cart[p.name]).map(p => ({...p, ...this.cart[p.name]}));
                if (items.length === 0) { container.innerHTML = "Liste ist leer."; return; }
                container.innerHTML = items.map(item => `
                    <div class="shopping-list-item ${item.checked ? 'checked' : ''}">
                        <div style="display:flex; align-items:center; gap:10px;" onclick="app.toggleCheck('${item.name}')">
                            <input type="checkbox" ${item.checked ? 'checked' : ''}>
                            <span>${item.icon} ${item.name} (${item.side})</span>
                        </div>
                        <span style="font-weight:bold;">${item.qty}x</span>
                    </div>
                `).join('');
                this.currentItems = items;
            },

            exportPDF: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Einkaufsliste", 10, 10);
                this.currentItems.forEach((item, i) => {
                    doc.text(`${item.qty}x ${item.name} (${item.side})`, 10, 20 + (i * 10));
                });
                doc.save("Einkauf.pdf");
            }
        };

        app.init();
    </script>
</body>
</html>